<!doctype html><html lang=it><head><meta charset=utf-8><meta name=author content="SeekBytes"><meta name=viewport content="width=device-width,initial-scale=1"><title>Lezione 7.B - System Call MentOS</title><link href=https://seekbytes.github.io/oslab/css/style.css rel=stylesheet type=text/css><link href=https://seekbytes.github.io/oslab/css/syntax.css rel=stylesheet type=text/css><link href=https://seekbytes.github.io/oslab/css/print.css rel=stylesheet media=print type=text/css><meta name=description content="Come implementare le system call su MentOS."><meta property="og:locale" content="it"><meta name=robots content="index,follow"><meta name=googlebot content="index,follow"></head><body class=flex><div class=navbar-lat><div class=links><h2>Indice</h2><nav id=TableOfContents><ul><li><ul><li><a href=#preparazione-per-lesercitazione>Preparazione per l&rsquo;esercitazione</a></li></ul></li><li><a href=#system-call>System Call</a><ul><li><a href=#ingredienti>Ingredienti</a></li><li><a href=#struttura-delle-cartelle-per-lesercizio>Struttura delle cartelle per l&rsquo;esercizio</a></li><li><a href=#come-funzionano-su-mentos>Come funzionano su MentOS</a></li><li><a href=#due-esempi-di-system-call>Due esempi di system call</a></li><li><a href=#come-posso-aggiungere-una-nuova-system-call-a-mentos>Come posso aggiungere una nuova system call a MentOS?</a></li></ul></li></ul></nav><h3>Contenuti</h3><ul><li><a href=https://seekbytes.github.io/oslab/lezioni/0-sistemi-operativi-laboratorio/>Lezione 0 - Introduzione a Sistemi Operativi Laboratorio</a></li><li><a href=https://seekbytes.github.io/oslab/lezioni/1-a-concetti-fondamentali/>Lezione 1.A - Concetti fondamentali: Processi e Programmi</a></li><li><a href=https://seekbytes.github.io/oslab/lezioni/1-b-file-system/>Lezione 1.B - Concetti fondamentali: File System</a></li><li><a href=https://seekbytes.github.io/oslab/lezioni/2-processi/>Lezione 2 - Processi</a></li><li><a href=https://seekbytes.github.io/oslab/lezioni/3-mentos/>Lezione 3.A - Fondamentali di MentOS</a></li><li><a href=https://seekbytes.github.io/oslab/lezioni/3-b-mentos-scheduling/>Lezione 3.B - MentOS Scheduling</a></li><li><a href=https://seekbytes.github.io/oslab/lezioni/4-a-semafori-ipc/>Lezione 4.A - IPC e Semafori</a></li><li><a href=https://seekbytes.github.io/oslab/lezioni/4-b-segnali-ipc/>Lezione 4.B - IPC e Segnali</a></li><li><a href=https://seekbytes.github.io/oslab/lezioni/5-memoria-condivisa-coda-di-messaggi/>Lezione 5 - Memoria condivisa e coda di messaggi</a></li><li><a href=https://seekbytes.github.io/oslab/lezioni/6-pipe-fifo/>Lezione 6 - Pipe e FIFO</a></li><li><a href=https://seekbytes.github.io/oslab/lezioni/7-a-struttura-mentos/>Lezione 7.A - Struttura di MentOS</a></li><li><a href=https://seekbytes.github.io/oslab/lezioni/7-b-mentos-system-call/>Lezione 7.B - System Call MentOS</a></li><li><a href=https://seekbytes.github.io/oslab/lezioni/7-c-mentos-deadlock/>Lezione 7.C - MentOS Deadlock</a></li><li><a href=https://seekbytes.github.io/oslab/lezioni/8-mentos-buddy-system/>Lezione 8 - MentOS Buddy System</a></li></ul><a href=../>Sezione principale</a></div></div><div class=content><a href=https://seekbytes.github.io/oslab/ id=returnBack>Ritorna indietro</a><h1>Lezione 7.B - System Call MentOS</h1><p class=details>Pubblicato il 4/26/22 da – 444 parole</p><h3 id=preparazione-per-lesercitazione>Preparazione per l&rsquo;esercitazione</h3><ol><li>Salva il tuo lavoro! Esempio: <code>MentOS/src/process/scheduler_algorithm.c</code>.</li><li>Ripristina la repo di lavoro, riportandola allo stato originale con <code>git reset --hard</code>.</li><li>Aggiorna la repo di lavoro con <code>git pull</code></li><li>Cambia branch di git utilizzando <code>git checkout --track origin/feature/Feature-DeadlockEsercise</code>.</li></ol><h2 id=system-call>System Call</h2><h3 id=ingredienti>Ingredienti</h3><p>Gli ingredienti sono:</p><ul><li>una funzione kernel-side</li><li>una funzione user-side</li><li>un numero univoco associato alla system call</li></ul><p>Per esempio:</p><ul><li>funzione kernel-side <code>int sys_open(const char *pathname, int flags, mode t mode);</code></li><li>funzione user-side <code>int open(const char *pathname, int flags, mode t mode);</code></li><li>numero univoco associato alla system call <code>#define __NR_open 5</code></li></ul><h3 id=struttura-delle-cartelle-per-lesercizio>Struttura delle cartelle per l&rsquo;esercizio</h3><p><code>inc/sys/unistd.h</code></p><ul><li>Il file che definisce le system call user-side</li><li>Nell&rsquo;esempio, il file contiene la funzione open()</li></ul><p><code>src/libc/unistd/*.c</code></p><ul><li>I file implementano le system call user-side</li><li>In pratica, preparano gli argomenti per la system call di sistema e chiamano l&rsquo;interrupt 80</li><li>La open è implementata all&rsquo;interno src/libc/unistd/open.c</li></ul><p><code>inc/system/syscall_types.h</code></p><ul><li>contiene la lista dei numeri di system call</li><li>nell&rsquo;esempio: <code>#define __NR_open 5</code></li></ul><h3 id=come-funzionano-su-mentos>Come funzionano su MentOS</h3><p><img src=../../images/lezioni/7/syscall.png alt></p><h3 id=due-esempi-di-system-call>Due esempi di system call</h3><p>Preparare i registri è un&rsquo;operazione semplice grazie ad alcune macro (<code>DEF_SYSCALLN</code> dove <code>N</code> è il numero di parametri da passare alle syscall).</p><p>Esempio con la <code>open</code> (3 parametri da passare):<div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>int</span> <span class=nf>open</span><span class=p>(</span><span class=k>const</span> <span class=kt>char</span> <span class=o>*</span><span class=n>pathname</span><span class=p>,</span> <span class=kt>int</span> <span class=n>flags</span><span class=p>,</span> <span class=kt>mode_t</span> <span class=n>mode</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kt>ssize_t</span> <span class=n>retval</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nf>DEFN_SYSCALL3</span><span class=p>(</span><span class=n>retval</span><span class=p>,</span> <span class=n>__NR_open</span><span class=p>,</span> <span class=n>pathname</span><span class=p>,</span> <span class=n>flags</span><span class=p>,</span> <span class=n>mode</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>retval</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=n>errno</span> <span class=o>=</span> <span class=o>-</span><span class=n>retval</span><span class=p>,</span> <span class=n>retval</span> <span class=o>=</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>retval</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></p><p>Esempio con la <code>close</code> (1 parametro da passare):<div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=kt>int</span> <span class=nf>close</span><span class=p>(</span><span class=kt>int</span> <span class=n>fd</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=kt>int</span> <span class=n>retval</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=nf>DEFN_SYSCALL1</span><span class=p>(</span><span class=n>retval</span><span class=p>,</span> <span class=n>__NR_close</span><span class=p>,</span> <span class=n>fd</span><span class=p>);</span>
</span></span><span class=line><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>retval</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=cl>		<span class=n>errno</span> <span class=o>=</span> <span class=o>-</span><span class=n>retval</span><span class=p>,</span> <span class=n>retval</span> <span class=o>=</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>	<span class=k>return</span> <span class=n>retval</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span></span></span></code></pre></div></p><h3 id=come-posso-aggiungere-una-nuova-system-call-a-mentos>Come posso aggiungere una nuova system call a MentOS?</h3><p>Assumiamo di avere le seguenti funzioni kernel-side implementate nei file <code>inc/experimental/smart_sem_kernel.h,</code>, <code>src/experimental/smart_sem_kernel.c</code>.</p><ul><li><code>int sys_sem_create();</code> creazione di un semaforo.</li><li><code>int sys_sem_destroy(int id)</code> distruzione di un semaforo.</li><li><code>int sys_sem_init(int id)</code> inizializzazione di un semaforo</li><li><code>int sys_sem_try_acquire(int id)</code> tenta un&rsquo;aquisizione di un semaforo identificato da un ID, e se disponibile, ne prende il possesso</li><li><code>int sys_sem_release(int id)</code> rilascia il possesso di un semaforo</li></ul><p>Assumiamo inoltre che abbiamo definito le seguenti funzioni user-side (ma <strong>vuote</strong>)</p><ul><li><code>int sem_create();</code></li><li><code>int sem_destroy(int id);</code></li><li><code>int sem_init(int id);</code></li><li><code>int sem_acquire(int id);</code></li><li><code>int sem_release(int id);</code></li></ul><p>Per aggiungere nuove system call, dobbiamo eseguire i seguenti passaggi.</p><ol><li>Apri il file <code>inc/system/syscall_types.h</code> e scegli un numero per la tua system call:
<code>#define __NR_sem... 190</code></li><li>Apri il file <code>src/system/syscall.c</code> e registra/associa la tua system call e il suo numero all&rsquo;interno della system call table
<code>sys_call_table[__NR_sem_ ...] = (SystemCall)sys_sem_...;</code></li><li>Apri il file <code>src/experimental/smart_sem_user.c</code> e riempi le system call definite a lato utente (prendendo ispirazioni con le altre system call definite a livello utente). Scrivi le system call utilizzando le macro!</li></ol><p>Presta attenzione ai nomi delle funzioni che chiami! Il prefisso <code>sys</code> indica una syscall definita a lato kernel.</p><footer><p>Contenuto basato sulle slide del corso di Sistemi Operativi A.A Laboratorio 2021-2022 UniVR. Copyright degli autori delle slide originali.
<a href=https://github.com/seekbytes/oslab/edit/main/content/lezioni/7_b_system_call.md>Modifica questa pagina</a></p></footer></div></body></html>